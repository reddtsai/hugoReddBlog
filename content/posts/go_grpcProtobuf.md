---
title: "ä½¿ç”¨ gRPC In Go"
date: 2020-08-16T23:26:44+08:00
description: how to use grpc with go
draft: false
hideToc: false
enableToc: true
enableTocContent: true
author: Redd Tsai
authorEmoji: ğŸ”
tags:
- Go
categories:
- Go
---

RPC(Remote Procedure Call) æ˜¯ä¸€å€‹é›»è…¦é€šè¨Šå”å®šï¼Œæœ€æ—©ç”¨åœ¨ç¶²è·¯æª”æ¡ˆç³»çµ±ä¸Šï¼Œé€éè©²å”å®šå…è¨±ç³»çµ±ä¸Šçš„ç¨‹å¼å­˜å–å…¶å®ƒç³»çµ±ä¸Šçš„æª”æ¡ˆã€‚å¦‚ä»Šï¼Œå¦‚æœä½ æœ‰æ¥è§¸å¾®æœå‹™ï¼Œä¹Ÿå¸¸ä½¿ç”¨ RPC ä¾†å»ºç«‹æœå‹™é–“çš„é€šè¨Šã€‚

{{< alert theme="info" >}}
ä»¥ä¸‹èªªæ˜æ‰€ä½¿ç”¨çš„ç’°å¢ƒ
OS    ï¼šMac
Golangï¼š1.14
Protocol Bufferï¼š3
Editerï¼šVisual Studio Code
{{< /alert >}}

### Define

é¦–å…ˆé€é Protocol Buffer ä¾†å®šç¾© grpc serviceï¼š
sample.proto
``` bash
syntax = "proto3";
option go_package = ".;rpc";

service SampleService {
    rpc SayHello (HelloRequest) returns (HelloReply) {}
}  

message HelloRequest {
    string name = 1;
}

message HelloReply {
    string message = 1;
}
```
ç·¨è­¯ sample.proto ç”Ÿæˆ sample.pb.goï¼š
``` bash
protoc -I proto --go_out=plugins=grpc:pkg/gRPC proto/sample.proto 
```
åœ¨ sample.pb.go æœ€ä¸Šæ–¹å¯çœ‹åˆ°ç‰ˆæœ¬çš„è¨Šæ¯ï¼Œå¾€ä¸‹å¯ä»¥çœ‹åˆ°å‰›å‰›æ‰€å®šç¾© SampleServiceï¼š
``` go
// Code generated by protoc-gen-go. DO NOT EDIT.
// versions:
// 	protoc-gen-go v1.25.0
// 	protoc        v3.12.3
// source: sample.proto

// ~~~~ ç•¥

// SampleServiceServer is the server API for SampleService service.
type SampleServiceServer interface {
	SayHello(context.Context, *HelloRequest) (*HelloReply, error)
}

// ~~~~ ç•¥
```

{{< alert theme="warning" >}}
é€™è£¡ç‰¹åˆ¥éœ€æ³¨æ„ grpcï¼Œprotobuf å’Œ protoc-gen-go ç‰ˆæœ¬æ˜¯å¦ç›¸å®¹ã€‚
å‡è¨­ç•¶ä¸­æŸä¸€å€‹çš„ç‰ˆæœ¬è¼ƒé«˜ï¼Œå¯èƒ½æœƒæœ‰æ‰¾ä¸åˆ°æ–¹æ³•çš„å•é¡Œ proto.Marshal: missing method ProtoReflectã€‚
{{< /alert >}}

### Server

æ¥è‘—é€é sample.pb.go ä¾†å¯¦ä½œ grpc serverï¼Œé€™è£¡å®šç¾©ä¸€å€‹ server ä¾†ç¹¼æ‰¿ SampleService æ¥å£ï¼Œä¸¦å¯¦ä½œ SayHello çš„å…§å®¹ï¼š
``` go
// ~~~~ ç•¥

func main() {
	lis, err := net.Listen("tcp", ":6424")
	if err != nil {
		fmt.Println(err)
	}
	s := grpc.NewServer()
	fmt.Println("grpc sample service ...")
	rpc.RegisterSampleServiceServer(s, &server{})
	if err := s.Serve(lis); err != nil {
		fmt.Println(err)
	}
}

type server struct {
	rpc.SampleServiceServer
}

func (s *server) SayHello(ctx context.Context, in *rpc.HelloRequest) (*rpc.HelloReply, error) {
	return &rpc.HelloReply{Message: "Hello " + in.GetName()}, nil
}
```

### Client

client ç«¯ä¹Ÿæ˜¯ä½¿ç”¨ç›¸åŒçš„ protocol buffer ä¾†å‘¼å« SayHelloï¼š
``` go
func main() {
	conn, err := grpc.Dial("0.0.0.0:6424", grpc.WithInsecure(), grpc.WithBlock())
	if err != nil {
		fmt.Println(err)
	}
	defer conn.Close()
	c := rpc.NewSampleServiceClient(conn)
	ctx, cancel := context.WithTimeout(context.Background(), time.Second)
	defer cancel()
	r, err := c.SayHello(ctx, &rpc.HelloRequest{Name: "redd"})
	if err != nil {
		fmt.Println(err)
	}
	fmt.Println(r.GetMessage())
}
```

### Reference

[gRPC](https://www.grpc.io/docs/languages/go/)
[protobuf](https://reddtsai.github.io/zh/posts/go_protobuf/)